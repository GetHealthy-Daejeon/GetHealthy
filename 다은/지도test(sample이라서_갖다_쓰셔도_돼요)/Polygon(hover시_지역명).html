<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>건강하슈</title>
    <style>
      .area {
        position: absolute;
        background: #fff;
        border: 2px solid #888;
        border-radius: 5px;
        font-size: 30px;
        top: -5px;
        left: 15px;
        padding: 3%;
        font-weight: bold;
        width: auto;
        height: auto;
        color: rgb(7, 165, 213);
        /* hover시 등장하는 text box 설정 */
      }

      .info {
        font-size: 12px;
        padding: 5px;
      }

      .info .title {
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container">
      div.map
      <div id="map" style="width: 1000px; height: 950px"></div>
      <p id="result"></p>
    </div>
  </body>
  <script
    src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
    crossorigin="anonymous"
  ></script>
  <script
    type="text/javascript"
    src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a73b8837893f3cb09f044c404d50bca2"
  ></script>
  <script>
    var mapContainer = document.getElementById("map"), // 지도를 div
      mapOption = {
        center: new kakao.maps.LatLng(36.3504119, 127.3845475), // 중심좌표
        level: 8,
      };
    var map = new kakao.maps.Map(mapContainer, mapOption); // 지도 생성
    // 행정구 이름 표시
    (customOverlay = new kakao.maps.CustomOverlay({})), 
    (infowindow = new kakao.maps.InfoWindow({ removable: true }));
    var markerPosition = new kakao.maps.LatLng(36.3504119, 127.3845475); // 마커 위치

    // 마커 생성
    var marker = new kakao.maps.Marker({
      position: markerPosition,
      clickable: true, // 마커를 클릭했을 때 지도의 클릭 이벤트가 발생하지 않도록 설정
    });
    marker.setMap(map); // 마커 표시

    // 마커 제거
    // marker.setMap(null);

    // 마커 클릭하면 나올 인포윈도우
      var iwContent =
        '<div style="padding:10px; font-size: 20px; width: 100%; font-weight: 900" >여기는 대전광역시</div>',
      iwRemoveable = true; // 인포윈도우를 닫는 x버튼 표시

    // 인포윈도우 생성
    var infowindow = new kakao.maps.InfoWindow({
      content: iwContent,
      removable: iwRemoveable,
    });

    // 마커 위에 인포윈도우 표시
    kakao.maps.event.addListener(marker, "click", function () {
      infowindow.open(map, marker);
    });

    // json 데이터 테스트
    $.getJSON("new-gu.json", function (data) {
      // console.log(data)
      // console.log(data.features)
      $(data.features).each(function () {
        // console.log($(this))
        // console.log($(this.geometry))
        // console.log($(this.geometry.coordinates[0]))
        $(this.geometry.coordinates[0]).each(function () {
          // console.log($(this)[1], $(this)[0])
        });
      });
    });
  </script>
  <script>
    // 구 구분
    $.getJSON("new-gu.json", function (geojson) {
      var data = geojson.features;
      var coordinates = []; // 좌표 저장
      var name = ""; // 구 이름
      $.each(data, function (index, val) {
        coordinates = val.geometry.coordinates;
        name = val.properties.SGG_NM;
        displayArea(coordinates, name);
      });
    });

    var polygons = [];
    // function 안 쪽에 지역변수로 넣으니깐 폴리곤 하나 생성할 때마다 배열이 비어서 클릭했을 때 전체를 못 없애줌.  그래서 전역변수로 만듦.

    // 구 폴리곤
    function displayArea(coordinates, name) {
      var polygonPath = []; // 폴리곤 그려줄 polygonPath
      var points = []; // 중심좌표 구하기 위한 지역구 좌표들
      $.each(coordinates[0], function (index, coordinate) {
        // coordinates [0]번째에 배열 있음
        var point = new Object();
        point.x = coordinate[1]; // 경도
        point.y = coordinate[0]; // 위도
        points.push(point);
        // console.log(point)
        // console.log(points)
        polygonPath.push(new kakao.maps.LatLng(coordinate[1], coordinate[0]));
        //new kakao.maps.LatLng가 없으면 인식을 못해서 polygonPath 배열에 추가
      });

      // 다각형 생성 & 설정
      var polygon = new kakao.maps.Polygon({
        map: map, // 다각형을 표시할 지도 객체
        path: polygonPath, // 좌표 배열
        strokeWeight: 2, // 선 두께
        strokeColor: "#004c80", // 선 색깔
        strokeOpacity: 0.8, // 선 불투명도
        fillColor: "#fff", // 채우기 색깔
        fillOpacity: 0.7, // 채우기 불투명도
      });

      polygons.push(polygon); // 폴리곤 제거하기 위한 배열

      // 다각형에 마우스오버 이벤트가 발생했을 때 변경할 채우기 옵션입니다
      var mouseoverOption = {
        fillColor: "#09f", // 채우기 색깔입니다
        fillOpacity: 0.8, // 채우기 불투명도 입니다
      };

      // 마우스아웃 이벤트 채우기
      var mouseoutOption = {
        fillColor: "#A2FF99", // 채우기 색깔
        fillOpacity: 0.7, // 채우기 불투명도
      };

      // 마우스오버 이벤트
      kakao.maps.event.addListener(polygon, "mouseover", function () {
        polygon.setOptions(mouseoverOption); // 채우기 옵션
      });

      // 다각형에 mouseover 이벤트를 등록하고 이벤트가 발생하면 폴리곤의 채움색을 변경
      // 지역명을 표시하는 커스텀오버레이를 지도위에 표시합니다
      kakao.maps.event.addListener(polygon, "mouseover", function (mouseEvent) {
        polygon.setOptions({
          fillColor: "#09f",
        });
        customOverlay.setContent('<div class="area">' + name + "</div>");
        customOverlay.setPosition(mouseEvent.latLng);
        customOverlay.setMap(map);
      });

      // 다각형에 mousemove 이벤트를 등록하고 이벤트가 발생하면 커스텀 오버레이의 위치를 변경합니다
      daum.maps.event.addListener(polygon, "mousemove", function (mouseEvent) {
        customOverlay.setPosition(mouseEvent.latLng);
      });

      // 다각형에 mouseout 이벤트를 등록하고 이벤트가 발생하면 폴리곤의 채움색을 원래색으로 변경합니다
      // 커스텀 오버레이를 지도에서 제거합니다
      daum.maps.event.addListener(polygon, "mouseout", function () {
        polygon.setOptions({
          fillColor: "#fff",
        });
        customOverlay.setMap(null);
      });

      // 다각형에 click 이벤트를 등록하고 이벤트가 발생하면 해당 지역 확대을 확대합니다.
      kakao.maps.event.addListener(polygon, "click", function () {
        // 현재 지도 레벨에서 2레벨 확대한 레벨
        var level = map.getLevel() - 2;
        // 지도를 클릭된 폴리곤의 중앙 위치를 기준으로 확대합니다
        map.setLevel(level, {
          anchor: centroid(points),
          animate: {
            duration: 50, //확대 애니메이션 시간
          },
        });
        // deletePolygon(polygons); //폴리곤 제거
      });
    }

    kakao.maps.event.addListener(polygon, "click", function (mouseEvent) {
      var content =
        '<div class="info">' +
        '   <div class="title">' +
        area.name +
        "</div>" +
        '   <div class="size">총 면적 : 약 ' +
        Math.floor(polygon.getArea()) +
        " m<sup>2</sup></div>" +
        "</div>";

      infowindow.setContent(content);
      infowindow.setPosition(mouseEvent.latLng);
      infowindow.setMap(map);
    });

    //centroid 알고리즘 (폴리곤 중심좌표 구하기 위함)
    function centroid(points) {
      var i, j, len, p1, p2, f, area, x, y;

      area = x = y = 0;

      for (i = 0, len = points.length, j = len - 1; i < len; j = i++) {
        p1 = points[i];
        p2 = points[j];

        f = p1.y * p2.x - p2.y * p1.x;
        x += (p1.x + p2.x) * f;
        y += (p1.y + p2.y) * f;
        area += f * 3;
      }
      return new daum.maps.LatLng(x / area, y / area);
    }

    //지도 위 표시되고 있는 폴리곤 제거
    function deletePolygon(polygons) {
      for (var i = 0; i < polygons.length; i++) {
        polygons[i].setMap(null);
      }
      polygons = [];
    }

    // kakao.maps.event.addListener(polygon, 'click', function(mouseEvent) {
    //     var content = '<div class="info">' +
    //                 '   <div class="title">' + area.name + '</div>' +
    //                 '   <div class="size">총 면적 : 약 ' + Math.floor(polygon.getArea()) + ' m<sup>2</sup></div>' +
    //                 '</div>';

    //     infowindow.setContent(content);
    //     infowindow.setPosition(mouseEvent.latLng);
    //     infowindow.setMap(map);
    // });
  </script>
</html>
